<html lang="en">

<head>
  <link rel="icon" type="image/png" href="/misc/favicon-32x32.png" sizes="32x32" />
  <link rel="icon" type="image/png" href="/misc/favicon-16x16.png" sizes="16x16" />

  <link href="https://fonts.googleapis.com/css?family=Lato:300,400,700" rel="stylesheet">
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <title>go-seq</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="/js/jquery.min.js"></script>
  <script src="/js/bootstrap.min.js"></script>
  <script src="/js/header.js"></script>
  <script src="/js/toc.js"></script>
  <link href="/css/bootstrap.min.css" rel="stylesheet">
  <link href="/css/theme.css" rel="stylesheet">
  <link href="/css/font-awesome/css/font-awesome.min.css" rel="stylesheet">
  <script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
  <script type="text/x-mathjax-config">
	MathJax.Hub.Config({
		tex2jax: {
			inlineMath: [ ['$','$'], ["\\(","\\)"] ],
			displayMath: [ ['$$','$$'], ["\\[","\\]"] ],
			processEscapes: false
		},
		"HTML-CSS": {
			preferredFont: "TeX",
		}
	})
  </script>
  <link href="/css/syntax.css" rel="stylesheet">
</head>

<body>

  

  


  <nav class="navbar navbar-inverse">
    <div class="container">
      <div class="navbar-header">
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="/">go-seq</a>
      </div>
      <div class="collapse navbar-collapse">
        <ul class="nav navbar-nav">
          <li><a href="/">/home</a></li>
          <li><a href="/archive.html">/archive</a></li>
          <li><a href="/tags.html">/tags</a></li>
          <li><a href="/about.html">/about</a></li>
          <li><a href="/feed.xml">/RSS</a></li>
        </ul>
      </div>
    </div>
  </nav>


<div class="wrapper">
  <div class="content">
    <div class="container container-center">
      <div class="row">
        <div class="col-md-12">
          <div class="article">
            <div class="well">
              <h1><a href="/2015/11/julia">Experiments with Julia</a></h1>
              <div class="post-meta">
                <div class="post-time">
                  <i class="fa fa-calendar"></i>
                  <time>21 Nov 2015</time>
                </div>
                <ul>
                  
                    <li><a href="/tag/julia">julia</a></li>
                  
                    <li><a href="/tag/c++">c++</a></li>
                  
                    <li><a href="/tag/simd">simd</a></li>
                  
                </ul>
              </div>
              <div class="post-content">
                <div id="toc" class="toc"></div>
                <h2 id="simd-support">SIMD Support</h2>

<p>Since version 0.3 Julia has some vectorisation capabilities that can exploit SIMD instructions when executing loops. It seems to require some nudging though. There are macros that are a bit like the pragmas in OpenMP.</p>

<h3 id="example-1-saxpy">Example 1. SAXPY</h3>
<div class="highlight"><pre><code class="language-julia" data-lang="julia"><span class="k">function</span><span class="nf"> saxpy</span><span class="p">(</span><span class="n">a</span><span class="p">::</span><span class="kt">Float32</span><span class="p">,</span> <span class="n">x</span><span class="p">::</span><span class="n">Array</span><span class="p">{</span><span class="kt">Float32</span><span class="p">,</span><span class="mi">1</span><span class="p">},</span> <span class="n">y</span><span class="p">::</span><span class="n">Array</span><span class="p">{</span><span class="kt">Float32</span><span class="p">,</span><span class="mi">1</span><span class="p">})</span>
  <span class="n">n</span> <span class="o">=</span> <span class="n">length</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
  <span class="k">for</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">:</span><span class="n">n</span>
    <span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+=</span> <span class="n">a</span><span class="o">*</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div>
<p>Sadly, in version 0.3.10 this obvious candidate does not auto-vectorise. 
You can inspect how this code has compiled nicely in Julia by using the macros <code>@code_llvm</code> to see the LLVM IR or <code>@code_native</code> to see the ASM. The ASM produced is:</p>
<div class="highlight"><pre><code class="language-nasm" data-lang="nasm"><span class="nf">Source</span> <span class="nv">line</span><span class="p">:</span> <span class="mi">48</span>
    <span class="nf">mov</span> <span class="nv">R8</span><span class="p">,</span> <span class="kt">QWORD</span> <span class="nv">PTR</span> <span class="p">[</span><span class="nb">RSI</span> <span class="o">+</span> <span class="mi">16</span><span class="p">]</span>
    <span class="nf">xor</span> <span class="nb">R11D</span><span class="p">,</span> <span class="nb">R11D</span>
    <span class="nf">xor</span> <span class="nb">ECX</span><span class="p">,</span> <span class="nb">ECX</span>
    <span class="nf">cmp</span> <span class="nb">RCX</span><span class="p">,</span> <span class="nv">R8</span>
    <span class="nf">jae</span> <span class="mi">65</span>
    <span class="nf">cmp</span> <span class="nb">RCX</span><span class="p">,</span> <span class="kt">QWORD</span> <span class="nv">PTR</span> <span class="p">[</span><span class="nb">RDI</span> <span class="o">+</span> <span class="mi">16</span><span class="p">]</span>
    <span class="nf">jae</span> <span class="mi">55</span>
    <span class="nf">lea</span> <span class="nv">R10</span><span class="p">,</span> <span class="kt">QWORD</span> <span class="nv">PTR</span> <span class="p">[</span><span class="mi">4</span><span class="o">*</span><span class="nv">R11</span><span class="p">]</span>
    <span class="nf">mov</span> <span class="nb">RAX</span><span class="p">,</span> <span class="kt">QWORD</span> <span class="nv">PTR</span> <span class="p">[</span><span class="nb">RSI</span> <span class="o">+</span> <span class="mi">8</span><span class="p">]</span>
    <span class="nf">sub</span> <span class="nb">RAX</span><span class="p">,</span> <span class="nv">R10</span>
    <span class="nf">mov</span> <span class="nb">RDX</span><span class="p">,</span> <span class="kt">QWORD</span> <span class="nv">PTR</span> <span class="p">[</span><span class="nb">RDI</span> <span class="o">+</span> <span class="mi">8</span><span class="p">]</span>
    <span class="nf">sub</span> <span class="nb">RDX</span><span class="p">,</span> <span class="nv">R10</span>
    <span class="nf">movss</span>   <span class="nv">XMM1</span><span class="p">,</span> <span class="kt">DWORD</span> <span class="nv">PTR</span> <span class="p">[</span><span class="nb">RDX</span><span class="p">]</span>
    <span class="nf">mulss</span>   <span class="nv">XMM1</span><span class="p">,</span> <span class="nv">XMM0</span>
    <span class="nf">addss</span>   <span class="nv">XMM1</span><span class="p">,</span> <span class="kt">DWORD</span> <span class="nv">PTR</span> <span class="p">[</span><span class="nb">RAX</span><span class="p">]</span>
    <span class="nf">movss</span>   <span class="kt">DWORD</span> <span class="nv">PTR</span> <span class="p">[</span><span class="nb">RAX</span><span class="p">],</span> <span class="nv">XMM1</span>
    <span class="nf">dec</span> <span class="nv">R11</span>
    <span class="nf">inc</span> <span class="nb">RCX</span>
    <span class="nf">cmp</span> <span class="nv">R9</span><span class="p">,</span> <span class="nb">RCX</span>
    <span class="nf">jne</span> <span class="o">-</span><span class="mi">72</span>
    <span class="nf">pop</span> <span class="nb">RBP</span>
    <span class="nf">ret</span>
    <span class="nf">movabs</span>  <span class="nb">RAX</span><span class="p">,</span> <span class="mi">140636405232096</span>
    <span class="nf">mov</span> <span class="nb">RDI</span><span class="p">,</span> <span class="kt">QWORD</span> <span class="nv">PTR</span> <span class="p">[</span><span class="nb">RAX</span><span class="p">]</span>
    <span class="nf">movabs</span>  <span class="nb">RAX</span><span class="p">,</span> <span class="mi">140636390845696</span>
    <span class="nf">mov</span> <span class="nb">ESI</span><span class="p">,</span> <span class="mi">48</span>
    <span class="nf">call</span>    <span class="nb">RAX</span>
</code></pre></div>
<p>Note the scalar instructions <code>movss</code>, <code>mulss</code>, and <code>addss</code>.</p>

<h3 id="example-2-saxpy-simd">Example 2: SAXPY + SIMD</h3>

<p>To make it generate vectorised instructions you have to use the <em>explicit vectorisation</em> macros <code>@simd</code> and <code>@inbounds</code> macros. <code>@simd</code> gives the compiler license to vectorise without checking the legality of the transformation. <code>@inbounds</code> is an optimisation that turns off subscript checking, because subscript checking might throw an exception and so isn&#39;t vectorisable.</p>
<div class="highlight"><pre><code class="language-julia" data-lang="julia"><span class="k">function</span><span class="nf"> axpy</span><span class="p">(</span><span class="n">a</span><span class="p">::</span><span class="kt">Float32</span><span class="p">,</span> <span class="n">x</span><span class="p">::</span><span class="n">Array</span><span class="p">{</span><span class="kt">Float32</span><span class="p">,</span><span class="mi">1</span><span class="p">},</span> <span class="n">y</span><span class="p">::</span><span class="n">Array</span><span class="p">{</span><span class="kt">Float32</span><span class="p">,</span><span class="mi">1</span><span class="p">})</span>
  <span class="n">n</span> <span class="o">=</span> <span class="n">length</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
  <span class="p">@</span><span class="n">simd</span> <span class="k">for</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">:</span><span class="n">n</span>
    <span class="p">@</span><span class="n">inbounds</span> <span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+=</span> <span class="n">a</span><span class="o">*</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div>
<p>This now compiles with SIMD instructions:</p>
<div class="highlight"><pre><code class="language-nasm" data-lang="nasm"><span class="nf">...</span>
<span class="nf">Source</span> <span class="nv">line</span><span class="p">:</span> <span class="mi">48</span>
    <span class="nf">mov</span> <span class="nv">R8</span><span class="p">,</span> <span class="kt">QWORD</span> <span class="nv">PTR</span> <span class="p">[</span><span class="nb">RDI</span> <span class="o">+</span> <span class="mi">8</span><span class="p">]</span>
    <span class="nf">mov</span> <span class="nv">R9</span><span class="p">,</span> <span class="kt">QWORD</span> <span class="nv">PTR</span> <span class="p">[</span><span class="nb">RSI</span> <span class="o">+</span> <span class="mi">8</span><span class="p">]</span>
    <span class="nf">xor</span> <span class="nb">EDI</span><span class="p">,</span> <span class="nb">EDI</span>
    <span class="nf">mov</span> <span class="nb">RSI</span><span class="p">,</span> <span class="nb">RAX</span>
    <span class="nf">and</span> <span class="nb">RSI</span><span class="p">,</span> <span class="o">-</span><span class="mi">8</span>
    <span class="nf">je</span>  <span class="mi">79</span>
    <span class="nf">pshufd</span>  <span class="nv">XMM1</span><span class="p">,</span> <span class="nv">XMM0</span><span class="p">,</span> <span class="mi">0</span>           <span class="err">#</span> <span class="nv">xmm1</span> <span class="err">=</span> <span class="nv">xmm0</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
    <span class="nf">xor</span> <span class="nb">EDI</span><span class="p">,</span> <span class="nb">EDI</span>
    <span class="nf">lea</span> <span class="nb">RCX</span><span class="p">,</span> <span class="kt">QWORD</span> <span class="nv">PTR</span> <span class="p">[</span><span class="mi">4</span><span class="o">*</span><span class="nb">RDI</span><span class="p">]</span>
    <span class="nf">mov</span> <span class="nb">RDX</span><span class="p">,</span> <span class="nv">R8</span>
    <span class="nf">sub</span> <span class="nb">RDX</span><span class="p">,</span> <span class="nb">RCX</span>
    <span class="nf">movups</span>  <span class="nv">XMM3</span><span class="p">,</span> <span class="nv">XMMWORD</span> <span class="nv">PTR</span> <span class="p">[</span><span class="nb">RDX</span><span class="p">]</span>
    <span class="nf">movups</span>  <span class="nv">XMM2</span><span class="p">,</span> <span class="nv">XMMWORD</span> <span class="nv">PTR</span> <span class="p">[</span><span class="nb">RDX</span> <span class="o">+</span> <span class="mi">16</span><span class="p">]</span>
    <span class="nf">mulps</span>   <span class="nv">XMM3</span><span class="p">,</span> <span class="nv">XMM1</span>
    <span class="nf">mov</span> <span class="nb">RDX</span><span class="p">,</span> <span class="nv">R9</span>
    <span class="nf">sub</span> <span class="nb">RDX</span><span class="p">,</span> <span class="nb">RCX</span>
    <span class="nf">movups</span>  <span class="nv">XMM5</span><span class="p">,</span> <span class="nv">XMMWORD</span> <span class="nv">PTR</span> <span class="p">[</span><span class="nb">RDX</span><span class="p">]</span>
    <span class="nf">movups</span>  <span class="nv">XMM4</span><span class="p">,</span> <span class="nv">XMMWORD</span> <span class="nv">PTR</span> <span class="p">[</span><span class="nb">RDX</span> <span class="o">+</span> <span class="mi">16</span><span class="p">]</span>
    <span class="nf">addps</span>   <span class="nv">XMM5</span><span class="p">,</span> <span class="nv">XMM3</span>
    <span class="nf">movups</span>  <span class="nv">XMMWORD</span> <span class="nv">PTR</span> <span class="p">[</span><span class="nb">RDX</span><span class="p">],</span> <span class="nv">XMM5</span>
    <span class="nf">mulps</span>   <span class="nv">XMM2</span><span class="p">,</span> <span class="nv">XMM1</span>
    <span class="nf">addps</span>   <span class="nv">XMM2</span><span class="p">,</span> <span class="nv">XMM4</span>
    <span class="nf">movups</span>  <span class="nv">XMMWORD</span> <span class="nv">PTR</span> <span class="p">[</span><span class="nb">RDX</span> <span class="o">+</span> <span class="mi">16</span><span class="p">],</span> <span class="nv">XMM2</span>
    <span class="nf">add</span> <span class="nb">RDI</span><span class="p">,</span> <span class="o">-</span><span class="mi">8</span>
    <span class="nf">mov</span> <span class="nb">RCX</span><span class="p">,</span> <span class="nb">RSI</span>
    <span class="nf">add</span> <span class="nb">RCX</span><span class="p">,</span> <span class="nb">RDI</span>
    <span class="nf">jne</span> <span class="o">-</span><span class="mi">69</span>
    <span class="nf">mov</span> <span class="nb">RDI</span><span class="p">,</span> <span class="nb">RSI</span>
    <span class="nf">sub</span> <span class="nb">RAX</span><span class="p">,</span> <span class="nb">RDI</span>
    <span class="nf">je</span>  <span class="mi">41</span>
<span class="nf">...</span>
</code></pre></div>
<p>Note the instructions movups, addps, mulps... (English: move, unaligned, <strong>packed</strong>, single-precision). Packed =&gt; Vector.</p>

<p>We can also see from the LLVM IR:</p>
<div class="highlight"><pre><code class="language-llvm" data-lang="llvm"><span class="k">define</span> <span class="kt">void</span> <span class="vg">@julia_axpy_21664</span><span class="p">(</span><span class="kt">float</span><span class="p">,</span> <span class="nv">%jl_value_t</span><span class="p">*,</span> <span class="nv">%jl_value_t</span><span class="p">*)</span> <span class="p">{</span>
<span class="p">...</span>
  <span class="k">br</span> <span class="kt">label</span> <span class="nv">%vector.body</span>

<span class="nl">vector.body:</span>                                      <span class="c">; preds = %vector.body, %vector.ph</span>
  <span class="nv">%index</span> <span class="p">=</span> <span class="k">phi</span> <span class="k">i64</span> <span class="p">[</span> <span class="m">0</span><span class="p">,</span> <span class="nv">%vector.ph</span> <span class="p">],</span> <span class="p">[</span> <span class="nv">%index.next</span><span class="p">,</span> <span class="nv">%vector.body</span> <span class="p">]</span>
  <span class="nv-Anonymous">%25</span> <span class="p">=</span> <span class="k">getelementptr</span> <span class="kt">float</span><span class="p">*</span> <span class="nv-Anonymous">%20</span><span class="p">,</span> <span class="k">i64</span> <span class="nv">%index</span><span class="p">,</span> <span class="nv">!dbg</span> <span class="nv-Anonymous">!4955</span>
  <span class="nv-Anonymous">%26</span> <span class="p">=</span> <span class="k">bitcast</span> <span class="kt">float</span><span class="p">*</span> <span class="nv-Anonymous">%25</span> <span class="k">to</span> <span class="p">&lt;</span><span class="m">4</span> <span class="k">x</span> <span class="kt">float</span><span class="p">&gt;*</span>
  <span class="nv">%wide.load</span> <span class="p">=</span> <span class="k">load</span> <span class="p">&lt;</span><span class="m">4</span> <span class="k">x</span> <span class="kt">float</span><span class="p">&gt;*</span> <span class="nv-Anonymous">%26</span><span class="p">,</span> <span class="k">align</span> <span class="m">4</span>
  <span class="nv">%.sum18</span> <span class="p">=</span> <span class="k">or</span> <span class="k">i64</span> <span class="nv">%index</span><span class="p">,</span> <span class="m">4</span>
  <span class="nv-Anonymous">%27</span> <span class="p">=</span> <span class="k">getelementptr</span> <span class="kt">float</span><span class="p">*</span> <span class="nv-Anonymous">%20</span><span class="p">,</span> <span class="k">i64</span> <span class="nv">%.sum18</span>
  <span class="nv-Anonymous">%28</span> <span class="p">=</span> <span class="k">bitcast</span> <span class="kt">float</span><span class="p">*</span> <span class="nv-Anonymous">%27</span> <span class="k">to</span> <span class="p">&lt;</span><span class="m">4</span> <span class="k">x</span> <span class="kt">float</span><span class="p">&gt;*</span>
  <span class="nv">%wide.load9</span> <span class="p">=</span> <span class="k">load</span> <span class="p">&lt;</span><span class="m">4</span> <span class="k">x</span> <span class="kt">float</span><span class="p">&gt;*</span> <span class="nv-Anonymous">%28</span><span class="p">,</span> <span class="k">align</span> <span class="m">4</span>
  <span class="nv-Anonymous">%29</span> <span class="p">=</span> <span class="k">getelementptr</span> <span class="kt">float</span><span class="p">*</span> <span class="nv-Anonymous">%24</span><span class="p">,</span> <span class="k">i64</span> <span class="nv">%index</span><span class="p">,</span> <span class="nv">!dbg</span> <span class="nv-Anonymous">!4955</span>
  <span class="nv-Anonymous">%30</span> <span class="p">=</span> <span class="k">bitcast</span> <span class="kt">float</span><span class="p">*</span> <span class="nv-Anonymous">%29</span> <span class="k">to</span> <span class="p">&lt;</span><span class="m">4</span> <span class="k">x</span> <span class="kt">float</span><span class="p">&gt;*</span>
  <span class="nv">%wide.load10</span> <span class="p">=</span> <span class="k">load</span> <span class="p">&lt;</span><span class="m">4</span> <span class="k">x</span> <span class="kt">float</span><span class="p">&gt;*</span> <span class="nv-Anonymous">%30</span><span class="p">,</span> <span class="k">align</span> <span class="m">4</span>
  <span class="nv-Anonymous">%31</span> <span class="p">=</span> <span class="k">getelementptr</span> <span class="kt">float</span><span class="p">*</span> <span class="nv-Anonymous">%24</span><span class="p">,</span> <span class="k">i64</span> <span class="nv">%.sum18</span>
  <span class="nv-Anonymous">%32</span> <span class="p">=</span> <span class="k">bitcast</span> <span class="kt">float</span><span class="p">*</span> <span class="nv-Anonymous">%31</span> <span class="k">to</span> <span class="p">&lt;</span><span class="m">4</span> <span class="k">x</span> <span class="kt">float</span><span class="p">&gt;*</span>
  <span class="nv">%wide.load11</span> <span class="p">=</span> <span class="k">load</span> <span class="p">&lt;</span><span class="m">4</span> <span class="k">x</span> <span class="kt">float</span><span class="p">&gt;*</span> <span class="nv-Anonymous">%32</span><span class="p">,</span> <span class="k">align</span> <span class="m">4</span>
  <span class="nv-Anonymous">%33</span> <span class="p">=</span> <span class="k">fmul</span> <span class="p">&lt;</span><span class="m">4</span> <span class="k">x</span> <span class="kt">float</span><span class="p">&gt;</span> <span class="nv">%wide.load10</span><span class="p">,</span> <span class="nv">%broadcast.splat13</span>
  <span class="nv-Anonymous">%34</span> <span class="p">=</span> <span class="k">fmul</span> <span class="p">&lt;</span><span class="m">4</span> <span class="k">x</span> <span class="kt">float</span><span class="p">&gt;</span> <span class="nv">%wide.load11</span><span class="p">,</span> <span class="nv">%broadcast.splat13</span>
  <span class="nv-Anonymous">%35</span> <span class="p">=</span> <span class="k">fadd</span> <span class="p">&lt;</span><span class="m">4</span> <span class="k">x</span> <span class="kt">float</span><span class="p">&gt;</span> <span class="nv">%wide.load</span><span class="p">,</span> <span class="nv-Anonymous">%33</span>
  <span class="nv-Anonymous">%36</span> <span class="p">=</span> <span class="k">fadd</span> <span class="p">&lt;</span><span class="m">4</span> <span class="k">x</span> <span class="kt">float</span><span class="p">&gt;</span> <span class="nv">%wide.load9</span><span class="p">,</span> <span class="nv-Anonymous">%34</span>
  <span class="k">store</span> <span class="p">&lt;</span><span class="m">4</span> <span class="k">x</span> <span class="kt">float</span><span class="p">&gt;</span> <span class="nv-Anonymous">%35</span><span class="p">,</span> <span class="p">&lt;</span><span class="m">4</span> <span class="k">x</span> <span class="kt">float</span><span class="p">&gt;*</span> <span class="nv-Anonymous">%26</span><span class="p">,</span> <span class="k">align</span> <span class="m">4</span>
  <span class="k">store</span> <span class="p">&lt;</span><span class="m">4</span> <span class="k">x</span> <span class="kt">float</span><span class="p">&gt;</span> <span class="nv-Anonymous">%36</span><span class="p">,</span> <span class="p">&lt;</span><span class="m">4</span> <span class="k">x</span> <span class="kt">float</span><span class="p">&gt;*</span> <span class="nv-Anonymous">%28</span><span class="p">,</span> <span class="k">align</span> <span class="m">4</span>
  <span class="nv">%index.next</span> <span class="p">=</span> <span class="k">add</span> <span class="k">i64</span> <span class="nv">%index</span><span class="p">,</span> <span class="m">8</span>
  <span class="nv-Anonymous">%37</span> <span class="p">=</span> <span class="k">icmp</span> <span class="k">eq</span> <span class="k">i64</span> <span class="nv">%index.next</span><span class="p">,</span> <span class="nv">%n.vec</span>
  <span class="k">br</span> <span class="k">i1</span> <span class="nv-Anonymous">%37</span><span class="p">,</span> <span class="kt">label</span> <span class="nv">%middle.block</span><span class="p">,</span> <span class="kt">label</span> <span class="nv">%vector.body</span>

<span class="nl">middle.block:</span>                                     <span class="c">; preds = %vector.body, %if</span>
  <span class="nv">%resume.val</span> <span class="p">=</span> <span class="k">phi</span> <span class="k">i64</span> <span class="p">[</span> <span class="m">0</span><span class="p">,</span> <span class="nv">%if</span> <span class="p">],</span> <span class="p">[</span> <span class="nv">%n.vec</span><span class="p">,</span> <span class="nv">%vector.body</span> <span class="p">]</span>
  <span class="nv">%cmp.n</span> <span class="p">=</span> <span class="k">icmp</span> <span class="k">eq</span> <span class="k">i64</span> <span class="nv-Anonymous">%15</span><span class="p">,</span> <span class="nv">%resume.val</span>
  <span class="k">br</span> <span class="k">i1</span> <span class="nv">%cmp.n</span><span class="p">,</span> <span class="kt">label</span> <span class="nv">%L7</span><span class="p">,</span> <span class="kt">label</span> <span class="nv">%L</span>

<span class="p">...</span>
</code></pre></div>
<p>Timing of a function is easy to do:</p>
<div class="highlight"><pre><code class="language-julia" data-lang="julia"><span class="n">x</span> <span class="o">=</span> <span class="n">rand</span><span class="p">(</span><span class="kt">Float32</span><span class="p">,</span> <span class="mi">10000000</span><span class="p">)</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">rand</span><span class="p">(</span><span class="kt">Float32</span><span class="p">,</span> <span class="mi">10000000</span><span class="p">)</span>
<span class="n">a</span> <span class="o">=</span> <span class="n">float32</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>

<span class="p">@</span><span class="n">time</span> <span class="n">axpy</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">)</span>
</code></pre></div>
<p>However, you probably want to run this more than once since the first time you call a function, Julia JITs it so the timing won&#39;t be representative. Here are the timings of axpy with and without <code>@simd</code> with <code>length(x) == 10000000</code>:</p>

<table><thead>
<tr>
<th>@simd?</th>
<th>Time (s)</th>
</tr>
</thead><tbody>
<tr>
<td>yes</td>
<td>0.006527373</td>
</tr>
<tr>
<td>no</td>
<td>0.013172804</td>
</tr>
</tbody></table>

<p>Setup:
Hardware: <em>Intel(R) Core(TM) i5-3570 CPU @ 3.40GHz (AVX)</em>
Julia version: <em>0.3.11</em></p>

<h3 id="example-3-saxpy-implicit-vectorisation">Example 3: SAXPY + Implicit vectorisation</h3>

<p>In my experiments, I found that it is sometimes possible to get implicit vectorisation by using just <code>@inbounds</code> to disable bounds checking:</p>
<div class="highlight"><pre><code class="language-julia" data-lang="julia"><span class="k">function</span><span class="nf"> axpy</span><span class="p">(</span><span class="n">a</span><span class="p">::</span><span class="kt">Float32</span><span class="p">,</span> <span class="n">x</span><span class="p">::</span><span class="n">Array</span><span class="p">{</span><span class="kt">Float32</span><span class="p">,</span><span class="mi">1</span><span class="p">},</span> <span class="n">y</span><span class="p">::</span><span class="n">Array</span><span class="p">{</span><span class="kt">Float32</span><span class="p">,</span><span class="mi">1</span><span class="p">})</span>
  <span class="n">n</span> <span class="o">=</span> <span class="n">length</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
  <span class="k">for</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">:</span><span class="n">n</span>
    <span class="p">@</span><span class="n">inbounds</span> <span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+=</span> <span class="n">a</span><span class="o">*</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div>
<p>This generates the same ASM as Example 2. Other simple cases have required <code>@simd</code> as well, so explicit vectorisation seems to be the only option at the moment.</p>

<h4 id="simd-limitations-in-julia">SIMD Limitations in Julia</h4>

<ul>
<li>No SIMD functions. Function calls have to be inlined. Julia can manage to inline short functions itself.</li>
<li>Code must be <em>type-stable</em>. This means that there isn&#39;t implicit type conversion in the loop. This will prevent vectorisation and probably make it run slow serially too.</li>
<li>SIMD macro doesn&#39;t have the bells and whistles of the OpenMP SIMD pragma.</li>
<li>Doesn&#39;t appear to be any way to specify alignment of memory.</li>
<li>No outer loop vectorisation.</li>
<li>I can&#39;t find any diagnostic information about how things were optimised.</li>
<li>Does handle any branching besides some ifelse function.</li>
</ul>

<h4 id="more-info-on-vectorisation">More Info on Vectorisation</h4>

<p>See Intel page <a href="https://software.intel.com/en-us/articles/vectorization-in-julia">Vectorization in Julia</a>.</p>

<h2 id="case-study-fitzhugh-nagamo-pde">Case Study: Fitzhugh-Nagamo PDE</h2>

<p>Experiment with a non-trivial example of a PDE solver using the reaction-diffusion system described by:</p>

<p>$$
\begin{eqnarray}
\frac{\partial u}{\partial t} &amp;=&amp; a \nabla^2 u + u - u^3 - v - k \\
\tau\frac{\partial v}{\partial t} &amp;=&amp; b\nabla^2 v + u - v
\end{eqnarray}
$$</p>

<p>With Neumann boundary conditions, boundary of [1,1]^2, N=100^2, and T=[0.,10.].
This example is based on this <a href="http://ipython-books.github.io/featured-05/">online python example</a>. I implement this in C++ and Julia and compare the performance and the vectorisation. </p>

<p>Here is the code in Julia:</p>
<div class="highlight"><pre><code class="language-julia" data-lang="julia"><span class="k">function</span><span class="nf"> fitzhugh_nagumo</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">T</span><span class="p">)</span>
  <span class="c"># Define the constants</span>
  <span class="kd">const</span> <span class="n">aa</span> <span class="o">=</span> <span class="mf">2.8e-4</span>
  <span class="kd">const</span> <span class="n">bb</span> <span class="o">=</span> <span class="mf">5.0e-3</span>
  <span class="kd">const</span> <span class="err">τ</span> <span class="o">=</span> <span class="mf">0.1</span>
  <span class="kd">const</span> <span class="err">κ</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.005</span>
  <span class="kd">const</span> <span class="n">dx</span> <span class="o">=</span> <span class="mf">2.0</span> <span class="o">/</span> <span class="n">size</span>
  <span class="kd">const</span> <span class="n">dt</span> <span class="o">=</span> <span class="mf">0.9</span> <span class="o">*</span> <span class="n">dx</span><span class="o">^</span><span class="mi">2</span> <span class="o">/</span> <span class="mf">2.0</span>
  <span class="kd">const</span> <span class="n">invdx2</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">dx</span><span class="o">^</span><span class="mi">2</span>
  <span class="kd">const</span> <span class="n">dt_</span><span class="err">τ</span> <span class="o">=</span> <span class="n">dt</span> <span class="o">/</span> <span class="err">τ</span>

  <span class="c"># Random initial fields</span>
  <span class="n">u_old</span> <span class="o">=</span> <span class="n">rand</span><span class="p">(</span><span class="kt">Float64</span><span class="p">,</span> <span class="p">(</span><span class="n">size</span><span class="p">,</span><span class="n">size</span><span class="p">))</span>
  <span class="n">v_old</span> <span class="o">=</span> <span class="n">rand</span><span class="p">(</span><span class="kt">Float64</span><span class="p">,</span> <span class="p">(</span><span class="n">size</span><span class="p">,</span><span class="n">size</span><span class="p">))</span>

  <span class="n">u_new</span> <span class="o">=</span> <span class="n">Array</span><span class="p">(</span><span class="kt">Float64</span><span class="p">,</span> <span class="p">(</span><span class="n">size</span><span class="p">,</span><span class="n">size</span><span class="p">))</span>
  <span class="n">v_new</span> <span class="o">=</span> <span class="n">Array</span><span class="p">(</span><span class="kt">Float64</span><span class="p">,</span> <span class="p">(</span><span class="n">size</span><span class="p">,</span><span class="n">size</span><span class="p">))</span>

  <span class="k">for</span> <span class="n">t</span> <span class="o">=</span> <span class="mf">0.0</span> <span class="p">:</span> <span class="n">dt</span> <span class="p">:</span> <span class="n">T</span>
    <span class="k">for</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">2</span><span class="p">:</span><span class="n">size</span><span class="o">-</span><span class="mi">1</span>
      <span class="k">for</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">2</span><span class="p">:</span><span class="n">size</span><span class="o">-</span><span class="mi">1</span>
        <span class="err">Δ</span><span class="n">u</span> <span class="o">=</span> <span class="n">invdx2</span> <span class="o">*</span> <span class="p">(</span><span class="n">u_old</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">+</span> <span class="n">u_old</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">+</span> <span class="n">u_old</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
                        <span class="o">+</span> <span class="n">u_old</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">4</span><span class="o">*</span><span class="n">u_old</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">])</span>
        <span class="err">Δ</span><span class="n">v</span> <span class="o">=</span> <span class="n">invdx2</span> <span class="o">*</span> <span class="p">(</span><span class="n">v_old</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">+</span> <span class="n">v_old</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">+</span> <span class="n">v_old</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
                        <span class="o">+</span> <span class="n">v_old</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">4</span><span class="o">*</span><span class="n">v_old</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">])</span>

        <span class="n">u_new</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">u_old</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">+</span> <span class="n">dt</span> <span class="o">*</span> <span class="p">(</span><span class="n">aa</span><span class="o">*</span><span class="err">Δ</span><span class="n">u</span> <span class="o">+</span> <span class="n">u_old</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">-</span> <span class="n">u_old</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">*</span><span class="n">u_old</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">*</span><span class="n">u_old</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> 
                                        <span class="o">-</span> <span class="n">v_old</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">+</span> <span class="err">κ</span><span class="p">)</span>
        <span class="n">v_new</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">v_old</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">+</span> <span class="n">dt_</span><span class="err">τ</span> <span class="o">*</span> <span class="p">(</span><span class="n">bb</span><span class="o">*</span><span class="err">Δ</span><span class="n">v</span> <span class="o">+</span> <span class="n">u_old</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">-</span> <span class="n">v_old</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">])</span>
      <span class="k">end</span>
    <span class="k">end</span>

    <span class="c">#print_vars(u_new[1,2], v_new[1,2], 0, 0, t)</span>

    <span class="c"># fix neumann boundary conditions</span>
    <span class="k">for</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">:</span><span class="n">size</span>
      <span class="n">u_new</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">u_new</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span>
      <span class="n">u_new</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">size</span><span class="p">]</span> <span class="o">=</span> <span class="n">u_new</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">size</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
      <span class="n">v_new</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">v_new</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span>
      <span class="n">v_new</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">size</span><span class="p">]</span> <span class="o">=</span> <span class="n">v_new</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">size</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">end</span>

    <span class="k">for</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">1</span><span class="p">:</span><span class="n">size</span>
      <span class="n">u_new</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">u_new</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="n">j</span><span class="p">]</span>
      <span class="n">u_new</span><span class="p">[</span><span class="n">size</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">u_new</span><span class="p">[</span><span class="n">size</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span><span class="p">]</span>
      <span class="n">v_new</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">v_new</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="n">j</span><span class="p">]</span>
      <span class="n">v_new</span><span class="p">[</span><span class="n">size</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">v_new</span><span class="p">[</span><span class="n">size</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span><span class="p">]</span>
    <span class="k">end</span>

    <span class="c"># swap new and old</span>
    <span class="n">u_new</span><span class="p">,</span> <span class="n">u_old</span> <span class="o">=</span> <span class="n">u_old</span><span class="p">,</span> <span class="n">u_new</span>
    <span class="n">v_new</span><span class="p">,</span> <span class="n">v_old</span> <span class="o">=</span> <span class="n">v_old</span><span class="p">,</span> <span class="n">v_new</span>
  <span class="k">end</span>

  <span class="k">return</span> <span class="p">(</span><span class="n">u_old</span><span class="p">,</span> <span class="n">v_old</span><span class="p">)</span>
<span class="k">end</span>
</code></pre></div>
<p>Here is the code in C++:</p>
<div class="highlight"><pre><code class="language-c++" data-lang="c++"><span class="cp">#include &lt;iostream&gt;</span>
<span class="cp">#include &lt;random&gt;</span>
<span class="cp">#include &lt;algorithm&gt; </span><span class="c1">// swap</span>

<span class="cp">#define N 100</span>

<span class="n">std</span><span class="o">::</span><span class="n">random_device</span> <span class="n">rd</span><span class="p">;</span>
<span class="n">std</span><span class="o">::</span><span class="n">mt19937</span> <span class="n">mt</span><span class="p">(</span><span class="n">rd</span><span class="p">());</span>

<span class="kt">double</span> <span class="nf">fitzhugh_nagumo</span><span class="p">(</span><span class="kt">double</span> <span class="n">T</span><span class="p">)</span>
<span class="p">{</span>
    <span class="c1">// Define the constants</span>
    <span class="k">const</span> <span class="kt">double</span> <span class="n">aa</span> <span class="o">=</span> <span class="mf">2.8e-4</span><span class="p">;</span>
    <span class="k">const</span> <span class="kt">double</span> <span class="n">bb</span> <span class="o">=</span> <span class="mf">5.0e-3</span><span class="p">;</span>
    <span class="k">const</span> <span class="kt">double</span> <span class="n">tau</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">;</span>
    <span class="k">const</span> <span class="kt">double</span> <span class="n">kappa</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.005</span><span class="p">;</span>
    <span class="k">const</span> <span class="kt">double</span> <span class="n">dx</span> <span class="o">=</span> <span class="mf">2.0</span> <span class="o">/</span> <span class="n">N</span><span class="p">;</span>
    <span class="k">const</span> <span class="kt">double</span> <span class="n">dt</span> <span class="o">=</span> <span class="mf">0.9</span> <span class="o">*</span> <span class="n">dx</span><span class="o">*</span><span class="n">dx</span> <span class="o">/</span> <span class="mf">2.0</span><span class="p">;</span>
    <span class="k">const</span> <span class="kt">double</span> <span class="n">invdx2</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="p">(</span><span class="n">dx</span><span class="o">*</span><span class="n">dx</span><span class="p">);</span>
    <span class="k">const</span> <span class="kt">double</span> <span class="n">dt_tau</span> <span class="o">=</span> <span class="n">dt</span> <span class="o">/</span> <span class="n">tau</span><span class="p">;</span>

    <span class="c1">// Random initial fields</span>
    <span class="kt">double</span> <span class="n">u_old</span><span class="p">[</span><span class="n">N</span><span class="p">][</span><span class="n">N</span><span class="p">];</span>
    <span class="kt">double</span> <span class="n">v_old</span><span class="p">[</span><span class="n">N</span><span class="p">][</span><span class="n">N</span><span class="p">];</span>
    <span class="kt">double</span> <span class="n">u_new</span><span class="p">[</span><span class="n">N</span><span class="p">][</span><span class="n">N</span><span class="p">];</span>
    <span class="kt">double</span> <span class="n">v_new</span><span class="p">[</span><span class="n">N</span><span class="p">][</span><span class="n">N</span><span class="p">];</span>

    <span class="n">std</span><span class="o">::</span><span class="n">uniform_real_distribution</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span> <span class="n">rng</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span><span class="mf">1.</span><span class="p">);</span>

    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">N</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">N</span><span class="p">;</span> <span class="o">++</span><span class="n">j</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">u_old</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">rng</span><span class="p">(</span><span class="n">mt</span><span class="p">);</span>
            <span class="n">v_old</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">rng</span><span class="p">(</span><span class="n">mt</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="c1">// Solver</span>
    <span class="kt">int</span> <span class="n">Nt</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="p">(</span><span class="n">T</span> <span class="o">/</span> <span class="n">dt</span><span class="p">);</span>
    <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Nt = &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">Nt</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">t</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">t</span> <span class="o">&lt;</span> <span class="n">Nt</span><span class="p">;</span> <span class="o">++</span><span class="n">t</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="c1">// evolve inner coordinates</span>
        <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">N</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">N</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span> <span class="o">++</span><span class="n">j</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="kt">double</span> <span class="n">delta_u</span> <span class="o">=</span> <span class="n">invdx2</span> <span class="o">*</span> <span class="p">(</span><span class="n">u_old</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">+</span> <span class="n">u_old</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> 
                                            <span class="o">+</span> <span class="n">u_old</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">u_old</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> 
                                            <span class="o">-</span> <span class="mi">4</span><span class="o">*</span><span class="n">u_old</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]);</span>
                <span class="kt">double</span> <span class="n">delta_v</span> <span class="o">=</span> <span class="n">invdx2</span> <span class="o">*</span> <span class="p">(</span><span class="n">v_old</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">+</span> <span class="n">v_old</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="n">j</span><span class="p">]</span>
                                            <span class="o">+</span> <span class="n">v_old</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">v_old</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> 
                                            <span class="o">-</span> <span class="mi">4</span><span class="o">*</span><span class="n">v_old</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]);</span>

                <span class="n">u_new</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">u_old</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">+</span> <span class="n">dt</span> <span class="o">*</span> <span class="p">(</span><span class="n">aa</span><span class="o">*</span><span class="n">delta_u</span> <span class="o">+</span> <span class="n">u_old</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span>
                                                    <span class="o">-</span> <span class="n">u_old</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span><span class="o">*</span><span class="n">u_old</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span><span class="o">*</span><span class="n">u_old</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">-</span> <span class="n">v_old</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> 
                                                    <span class="o">+</span> <span class="n">kappa</span><span class="p">);</span>
                <span class="n">v_new</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="n">After</span> <span class="n">i</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">v_old</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">+</span> <span class="n">dt_tau</span> <span class="o">*</span> <span class="p">(</span><span class="n">bb</span> <span class="o">*</span> <span class="n">delta_v</span> <span class="o">+</span> <span class="n">u_old</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">-</span> <span class="n">v_old</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]);</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="c1">// neumann boundary conditions</span>
        <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">N</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">u_new</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">u_new</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">];</span>
            <span class="n">u_new</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">N</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">u_new</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">N</span><span class="o">-</span><span class="mi">2</span><span class="p">];</span>
            <span class="n">v_new</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">v_new</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">];</span>
            <span class="n">v_new</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">N</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">v_new</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">N</span><span class="o">-</span><span class="mi">2</span><span class="p">];</span>
        <span class="p">}</span>

        <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">N</span><span class="p">;</span> <span class="o">++</span><span class="n">j</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">u_new</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">u_new</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">j</span><span class="p">];</span>
            <span class="n">u_new</span><span class="p">[</span><span class="n">N</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">u_new</span><span class="p">[</span><span class="n">N</span><span class="o">-</span><span class="mi">2</span><span class="p">][</span><span class="n">j</span><span class="p">];</span>
            <span class="n">v_new</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">v_new</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">j</span><span class="p">];</span>
            <span class="n">v_new</span><span class="p">[</span><span class="n">N</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">v_new</span><span class="p">[</span><span class="n">N</span><span class="o">-</span><span class="mi">2</span><span class="p">][</span><span class="n">j</span><span class="p">];</span>
        <span class="p">}</span>

        <span class="c1">// Swap old and new</span>
        <span class="n">std</span><span class="o">::</span><span class="n">swap</span><span class="p">(</span><span class="n">u_new</span><span class="p">,</span> <span class="n">u_old</span><span class="p">);</span>
        <span class="n">std</span><span class="o">::</span><span class="n">swap</span><span class="p">(</span><span class="n">v_new</span><span class="p">,</span> <span class="n">v_old</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">u_old</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">];</span>
<span class="p">}</span>
</code></pre></div>
<h3 id="results">Results</h3>

<p>Setup:</p>

<ul>
<li>Hardware: <em>Intel(R) Core(TM) i5-3570 CPU @ 3.40GHz (AVX)</em></li>
<li>Julia version: <em>0.3.10</em></li>
<li>C++ Compiler: <em>g++4.8</em></li>
</ul>

<table><thead>
<tr>
<th>Language</th>
<th>Notes</th>
<th>Time (s)</th>
</tr>
</thead><tbody>
<tr>
<td>Julia</td>
<td>None</td>
<td>5.993</td>
</tr>
<tr>
<td>Julia</td>
<td>@inbounds</td>
<td>3.105</td>
</tr>
<tr>
<td>Julia</td>
<td>@inbounds + @simd</td>
<td>3.0603</td>
</tr>
<tr>
<td>C++</td>
<td>-O0 -std=c++11</td>
<td>22.790</td>
</tr>
<tr>
<td>C++</td>
<td>-Ofast -std=c++11 -fno-tree-vectorize -fno-tree-slp-vectorize</td>
<td>3.2096</td>
</tr>
<tr>
<td>C++</td>
<td>-Ofast -std=c++11</td>
<td>2.142</td>
</tr>
</tbody></table>

<p>The best time in C++ is only 1.4x better than the best time in Julia. Inspecting the ASM of Julia + @inbounds + @simd shows that even with these macros Julia is still <em>not</em> generating vector instructions. :(. If I disable vectorisation in the C++ compiler, the times between Julia and C++ are much closer. This suggests that Julia could get even higher performance if it could generate vector instructions. I suppose that newer versions of Julia will improve this in the future. I find these results very impressive nonetheless. It will be worth trying with a newer LLVM version too.</p>

<h4 id="notes">Notes</h4>

<p>The thing holding back performance in the Julia code was the use of <code>u[i,j]^3</code> instead of <code>u[i,j]*u[i,j]*u[i,j]</code>. The former version compiles to a call of <code>pow(double, double)</code> from libm! The latter does what you expect. This is a <a href="https://github.com/JuliaLang/julia/issues/2741">known bug</a>. Fixed when Julia is built against LLVM 3.6. Version I&#39;m using is built with LLVM v3.4.</p>

              </div>
			  <div class="post-footer">
				  <div class="column-full">
					  <h3><a href="/archive.html">Blog archive</a></h3>
				  </div>
			  </div>
            </div>
          </div>
        </div>
        <!--
        <div class="col-md-3 hidden-xs">
          <div class="sidebar ">
  <h1>Recent Posts</h1>
  <ul>
    
    <li><a href="/2016/12/fleuronbovw">SIFTing Images</a></li>
    
    <li><a href="/2016/11/polyclojure3">Polymorphism in Clojure: A Tutorial Using Numbers, Part 3</a></li>
    
    <li><a href="/2016/11/polyclojure2">Polymorphism in Clojure: A Tutorial Using Numbers, Part 2</a></li>
    
    <li><a href="/2016/11/polyclojure1">Polymorphism in Clojure: A Tutorial Using Numbers, Part 1</a></li>
    
    <li><a href="/2015/11/julia">Experiments with Julia</a></li>
    
  </ul>
</div>

<div class="sidebar">
  <h1>Tags</h1>
  <ul>
    
      <li><a href="/tag/julia">julia</a></li>
    
      <li><a href="/tag/c++">c++</a></li>
    
      <li><a href="/tag/simd">simd</a></li>
    
      <li><a href="/tag/clojure">clojure</a></li>
    
      <li><a href="/tag/polymorphism">polymorphism</a></li>
    
      <li><a href="/tag/functional-programming">functional-programming</a></li>
    
      <li><a href="/tag/python">python</a></li>
    
      <li><a href="/tag/machine-learning">machine-learning</a></li>
    
      <li><a href="/tag/computer-vision">computer-vision</a></li>
    
      <li><a href="/tag/opencv">opencv</a></li>
    
      <li><a href="/tag/bovw">bovw</a></li>
    
  </ul>
</div>

		</div>
		-->
      </div>
	  

    </div>
  </div>
  <footer class="footer-distributed">
<div class="container">

	<div class="footer">
	<p><a href="/about">James Briggs</a> &copy; 2015-2016</p>
		<h6>Follow me</h6>

<ul class="social-media">

    
    <li>
        <a title="jimypbr on Github"
            href="https://github.com/jimypbr"
            target="_blank"><i class="fa fa-github fa-2x"></i></a>
    </li>
    

    
    <li>
        <a title="jimy-loon on StackOverflow"
			href="http://stackoverflow.com/users/jimy-loon"
            target="_blank"><i class="fa fa-stack-overflow fa-2x"></i></a>
    </li>
    

    
    <li>
        <a title="jimypbr on LinkedIn"
            href="https://www.linkedin.com/in/james-briggs-74229a65"
            target="_blank"><i class="fa fa-linkedin fa-2x"></i></a>
    </li>
    


    


    

    
    <li>
        <a title="feed.xml RSS"
            href="/feed.xml"
            target="_blank"><i class="fa fa-rss fa-2x"></i></a>
    </li>
    

</ul>

	</div>
	<div class="theme-origin">
		<p>Powered by <a href="https://jekyllrb.com/"> Jekyll</a>. Based on the theme <a href="https://github.com/streetturtle/jekyll-clean-dark">jekyll-clean-dark</a></p>.
</div>

</footer>

<!--
  <script type="text/javascript">
    var disqus_shortname = 'jimypbr';

   (function () {
     var s = document.createElement('script'); s.async = true;
     s.type = 'text/javascript';
     s.src = '//' + disqus_shortname + '.disqus.com/count.js';
     (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
   }());
 </script>

 -->

  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', '', 'auto');
    ga('send', 'pageview');
  </script>


</body>

</html>

</div>
